name: ðŸ› ï¸ Setup Universal Automation

on:
  workflow_dispatch:
    inputs:
      workflows:
        description: 'Which workflows to install?'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - quality-gate
        - health-monitor
        - auto-rollback
        - performance-audit
        - minimal (quality-gate + health-monitor)
      
      custom_config:
        description: 'Apply project-specific optimizations?'
        required: false
        default: true
        type: boolean
        
      enable_notifications:
        description: 'Enable notification workflows?'
        required: false
        default: false
        type: boolean

jobs:
  detect-project:
    name: ðŸ” Analyze Project
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.project_type }}
      framework: ${{ steps.detect.outputs.framework }}
      deployment: ${{ steps.detect.outputs.deployment }}
      recommendations: ${{ steps.detect.outputs.recommendations }}
      
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Detect Project Configuration
      id: detect
      run: |
        echo "ðŸ” Analyzing project structure..."
        
        PROJECT_TYPE="generic"
        FRAMEWORK="none"
        DEPLOYMENT="none"
        RECOMMENDATIONS=""
        
        # Detect framework
        if [ -f "package.json" ]; then
          if grep -q "next" package.json; then
            PROJECT_TYPE="frontend"
            FRAMEWORK="nextjs"
          elif grep -q "react" package.json && ! grep -q "next" package.json; then
            PROJECT_TYPE="frontend"
            FRAMEWORK="react"
          elif grep -q "vue" package.json; then
            PROJECT_TYPE="frontend"
            FRAMEWORK="vue"
          elif grep -q "svelte" package.json; then
            PROJECT_TYPE="frontend"
            FRAMEWORK="svelte"
          elif grep -q "express" package.json; then
            PROJECT_TYPE="backend"
            FRAMEWORK="express"
          else
            PROJECT_TYPE="javascript"
            FRAMEWORK="javascript"
          fi
        fi
        
        # Detect deployment
        if [ -f "netlify.toml" ] || [ -f "_redirects" ]; then
          DEPLOYMENT="netlify"
        elif [ -f "vercel.json" ]; then
          DEPLOYMENT="vercel"
        elif [ -f "firebase.json" ]; then
          DEPLOYMENT="firebase"
        fi
        
        # Generate recommendations
        if [ "$FRAMEWORK" = "nextjs" ]; then
          RECOMMENDATIONS="Next.js optimizations: Image optimization, bundle analysis, static export config"
        elif [ "$FRAMEWORK" = "react" ]; then
          RECOMMENDATIONS="React optimizations: Bundle splitting, performance monitoring"
        fi
        
        echo "ðŸ“Š Analysis Results:"
        echo "- Project Type: $PROJECT_TYPE"
        echo "- Framework: $FRAMEWORK"
        echo "- Deployment: $DEPLOYMENT"
        echo "- Recommendations: $RECOMMENDATIONS"
        
        echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
        echo "framework=$FRAMEWORK" >> $GITHUB_OUTPUT
        echo "deployment=$DEPLOYMENT" >> $GITHUB_OUTPUT
        echo "recommendations=$RECOMMENDATIONS" >> $GITHUB_OUTPUT

  install-workflows:
    name: ðŸ“¦ Install Automation Workflows
    runs-on: ubuntu-latest
    needs: detect-project
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“¦ Download Universal Workflows
      run: |
        echo "ðŸ“¦ Installing automation workflows..."
        
        BASE_URL="https://raw.githubusercontent.com/hadamaouattara/.github/main/workflow-templates"
        WORKFLOWS="${{ github.event.inputs.workflows }}"
        
        # Create workflows directory
        mkdir -p .github/workflows
        
        # Install workflows based on selection
        case $WORKFLOWS in
          "all")
            echo "ðŸ“¦ Installing all workflows..."
            curl -o .github/workflows/universal-quality-gate.yml "$BASE_URL/universal-quality-gate.yml"
            curl -o .github/workflows/universal-health-monitor.yml "$BASE_URL/universal-health-monitor.yml"
            curl -o .github/workflows/universal-auto-rollback.yml "$BASE_URL/universal-auto-rollback.yml"
            curl -o .github/workflows/universal-performance-audit.yml "$BASE_URL/universal-performance-audit.yml"
            ;;
            
          "minimal")
            echo "ðŸ“¦ Installing minimal workflows..."
            curl -o .github/workflows/universal-quality-gate.yml "$BASE_URL/universal-quality-gate.yml"
            curl -o .github/workflows/universal-health-monitor.yml "$BASE_URL/universal-health-monitor.yml"
            ;;
            
          "quality-gate")
            curl -o .github/workflows/universal-quality-gate.yml "$BASE_URL/universal-quality-gate.yml"
            ;;
            
          "health-monitor")
            curl -o .github/workflows/universal-health-monitor.yml "$BASE_URL/universal-health-monitor.yml"
            ;;
            
          "auto-rollback")
            curl -o .github/workflows/universal-auto-rollback.yml "$BASE_URL/universal-auto-rollback.yml"
            ;;
            
          "performance-audit")
            curl -o .github/workflows/universal-performance-audit.yml "$BASE_URL/universal-performance-audit.yml"
            ;;
        esac
        
        echo "âœ… Workflows downloaded successfully"

  configure-project:
    name: âš™ï¸ Configure Project Settings
    runs-on: ubuntu-latest
    needs: [detect-project, install-workflows]
    if: github.event.inputs.custom_config == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âš™ï¸ Apply Framework-Specific Configurations
      run: |
        echo "âš™ï¸ Applying project-specific configurations..."
        
        FRAMEWORK="${{ needs.detect-project.outputs.framework }}"
        
        case $FRAMEWORK in
          "nextjs")
            echo "ðŸš€ Configuring Next.js optimizations..."
            
            # Ensure proper Next.js config exists
            if [ ! -f "next.config.js" ]; then
              cat > next.config.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Automatic optimization
  poweredByHeader: false,
  reactStrictMode: true,
  
  // Performance optimizations
  experimental: {
    optimizeCss: true,
  },
  
  // Image optimization
  images: {
    formats: ['image/webp', 'image/avif'],
  },
}

module.exports = nextConfig
EOF
              echo "âœ… Created optimized next.config.js"
            fi
            ;;
            
          "react")
            echo "âš›ï¸ Configuring React optimizations..."
            
            # Add build optimization script if missing
            if [ -f "package.json" ] && ! grep -q "analyze" package.json; then
              npm install --save-dev source-map-explorer
              
              # Add bundle analyzer script
              node -e "
                const pkg = require('./package.json');
                pkg.scripts = pkg.scripts || {};
                pkg.scripts.analyze = 'npm run build && npx source-map-explorer build/static/js/*.js';
                require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
              "
              echo "âœ… Added bundle analysis script"
            fi
            ;;
        esac

  create-documentation:
    name: ðŸ“š Create Project Documentation
    runs-on: ubuntu-latest
    needs: [detect-project, install-workflows, configure-project]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“š Generate Automation Documentation
      run: |
        echo "ðŸ“š Creating automation documentation..."
        
        cat > AUTOMATION_SETUP.md << EOF
# ðŸ¤– Automation Setup Report

## ðŸ“Š Project Analysis
- **Project Type**: ${{ needs.detect-project.outputs.project_type }}
- **Framework**: ${{ needs.detect-project.outputs.framework }}
- **Deployment**: ${{ needs.detect-project.outputs.deployment }}
- **Date**: $(date)

## ðŸ› ï¸ Installed Workflows
- **Selection**: ${{ github.event.inputs.workflows }}
- **Custom Config**: ${{ github.event.inputs.custom_config }}
- **Notifications**: ${{ github.event.inputs.enable_notifications }}

### Active Workflows:
EOF

        # List installed workflows
        if [ -f ".github/workflows/universal-quality-gate.yml" ]; then
          echo "- âœ… **Quality Gate**: Validates every commit" >> AUTOMATION_SETUP.md
        fi
        
        if [ -f ".github/workflows/universal-health-monitor.yml" ]; then
          echo "- âœ… **Health Monitor**: Post-deployment validation" >> AUTOMATION_SETUP.md
        fi
        
        if [ -f ".github/workflows/universal-auto-rollback.yml" ]; then
          echo "- âœ… **Auto Rollback**: Emergency recovery system" >> AUTOMATION_SETUP.md
        fi
        
        if [ -f ".github/workflows/universal-performance-audit.yml" ]; then
          echo "- âœ… **Performance Audit**: Daily performance monitoring" >> AUTOMATION_SETUP.md
        fi

        cat >> AUTOMATION_SETUP.md << EOF

## ðŸŽ¯ Next Steps

### Immediate Actions:
1. **Test the workflows** by making a commit
2. **Check Actions tab** to see workflows in action
3. **Review workflow logs** for any issues

### Recommended Optimizations:
${{ needs.detect-project.outputs.recommendations }}

### Monitoring:
- Quality Gate runs on every push
- Health Monitor checks every 6 hours
- Performance Audit runs daily at 2 AM UTC
- Auto Rollback triggers on critical failures

## ðŸ†˜ Troubleshooting

If workflows fail:
1. Check the Actions tab for error details
2. Ensure required scripts exist in package.json
3. Verify project structure matches framework standards
4. Review AUTOMATION_TROUBLESHOOTING.md for common issues

## ðŸ“ž Support
- Documentation: https://github.com/hadamaouattara/.github
- Issues: Create an issue mentioning @hadamaouattara
- Templates: Available in the .github repository

---
**Generated by Universal Automation Setup**
EOF

        echo "âœ… Documentation created: AUTOMATION_SETUP.md"

  finalize-setup:
    name: âœ… Finalize Installation
    runs-on: ubuntu-latest
    needs: [detect-project, install-workflows, configure-project, create-documentation]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âœ… Commit All Changes
      run: |
        echo "âœ… Finalizing automation setup..."
        
        # Configure git
        git config user.name "Universal Automation Setup"
        git config user.email "automation@github-actions"
        
        # Add all changes
        git add .
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          # Create commit
          git commit -m "ðŸš€ Setup Universal GitHub Actions Automation

Installed workflows: ${{ github.event.inputs.workflows }}
Project type: ${{ needs.detect-project.outputs.project_type }}
Framework: ${{ needs.detect-project.outputs.framework }}
Custom config: ${{ github.event.inputs.custom_config }}

This commit adds comprehensive automation including:
- Quality gate validation
- Health monitoring
- Performance auditing
- Emergency rollback system

Generated by Universal Automation Setup"
          
          # Push changes
          git push
          
          echo "âœ… Automation setup completed successfully!"
        fi
        
    - name: ðŸŽ‰ Setup Complete
      run: |
        echo "ðŸŽ‰ =========================================="
        echo "ðŸŽ‰ UNIVERSAL AUTOMATION SETUP COMPLETE!"
        echo "ðŸŽ‰ =========================================="
        echo ""
        echo "âœ… Workflows installed: ${{ github.event.inputs.workflows }}"
        echo "âœ… Project type: ${{ needs.detect-project.outputs.project_type }}"
        echo "âœ… Framework: ${{ needs.detect-project.outputs.framework }}"
        echo "âœ… Custom configuration: ${{ github.event.inputs.custom_config }}"
        echo ""
        echo "ðŸŽ¯ WHAT HAPPENS NEXT:"
        echo "1. Quality Gate will validate your next commit"
        echo "2. Health Monitor will start checking every 6 hours"
        echo "3. Performance Audit will run daily"
        echo "4. Auto Rollback is ready for emergencies"
        echo ""
        echo "ðŸ“š Check AUTOMATION_SETUP.md for details"
        echo "ðŸ” Monitor progress in the Actions tab"
        echo ""
        echo "ðŸš€ Your project is now fully automated! ðŸš€"
