name: ğŸ›¡ï¸ Universal Quality Gate - Zero Error Deployment

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-project-type:
    name: ğŸ” Project Type Detection
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.project_type }}
      has_package_json: ${{ steps.detect.outputs.has_package_json }}
      has_next_config: ${{ steps.detect.outputs.has_next_config }}
      has_firebase: ${{ steps.detect.outputs.has_firebase }}
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Detect Project Configuration
      id: detect
      run: |
        echo "ğŸ” Analyzing project structure..."
        
        # Initialize detection variables
        PROJECT_TYPE="generic"
        HAS_PACKAGE_JSON="false"
        HAS_NEXT_CONFIG="false"
        HAS_FIREBASE="false"
        
        # Check for package.json
        if [ -f "package.json" ]; then
          HAS_PACKAGE_JSON="true"
          echo "âœ… Found: package.json"
          
          # Detect framework type
          if grep -q "next" package.json; then
            PROJECT_TYPE="nextjs"
            echo "ğŸš€ Detected: Next.js project"
          elif grep -q "react" package.json; then
            PROJECT_TYPE="react"
            echo "âš›ï¸ Detected: React project"
          elif grep -q "express" package.json; then
            PROJECT_TYPE="express"
            echo "ğŸš‚ Detected: Express.js project"
          fi
        fi
        
        # Check for Next.js config
        if [ -f "next.config.js" ] || [ -f "next.config.mjs" ]; then
          HAS_NEXT_CONFIG="true"
          echo "âš™ï¸ Found: Next.js configuration"
        fi
        
        # Check for Firebase
        if [ -f "firebase.json" ] || grep -q "firebase" package.json 2>/dev/null; then
          HAS_FIREBASE="true"
          echo "ğŸ”¥ Found: Firebase configuration"
        fi
        
        # Check for specific project patterns
        if [ -d "lib" ] && [ -d "contexts" ] && [ -d "components" ]; then
          PROJECT_TYPE="nextjs-app"
          echo "ğŸ“± Detected: Next.js App Router project"
        fi
        
        echo "ğŸ“Š Detection Summary:"
        echo "- Project Type: $PROJECT_TYPE"
        echo "- Has package.json: $HAS_PACKAGE_JSON"
        echo "- Has Next.js: $HAS_NEXT_CONFIG"
        echo "- Has Firebase: $HAS_FIREBASE"
        
        # Set outputs
        echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
        echo "has_package_json=$HAS_PACKAGE_JSON" >> $GITHUB_OUTPUT
        echo "has_next_config=$HAS_NEXT_CONFIG" >> $GITHUB_OUTPUT
        echo "has_firebase=$HAS_FIREBASE" >> $GITHUB_OUTPUT

  universal-quality-gate:
    name: ğŸ›¡ï¸ Universal Quality Validation
    runs-on: ubuntu-latest
    needs: detect-project-type
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js (if needed)
      if: needs.detect-project-type.outputs.has_package_json == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ” Structure Validation
      run: |
        echo "ğŸ” Performing universal structure validation..."
        
        PROJECT_TYPE="${{ needs.detect-project-type.outputs.project_type }}"
        
        # Common validations for all projects
        echo "ğŸ“ Basic structure checks:"
        
        # Check for README
        if [ -f "README.md" ]; then
          echo "âœ… README.md found"
        else
          echo "âš ï¸ WARNING: README.md missing"
        fi
        
        # Check for .gitignore
        if [ -f ".gitignore" ]; then
          echo "âœ… .gitignore found"
        else
          echo "âš ï¸ WARNING: .gitignore missing"
        fi
        
        # Framework-specific validations
        case $PROJECT_TYPE in
          "nextjs"|"nextjs-app")
            echo "ğŸš€ Next.js specific validations:"
            
            # Required files for Next.js
            REQUIRED_FILES=("package.json" "app/page.jsx" "app/layout.jsx")
            
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$file" ] || [ -f "${file/jsx/tsx}" ]; then
                echo "âœ… Found: $file"
              else
                echo "âŒ CRITICAL: Missing $file"
                exit 1
              fi
            done
            
            # Check for forbidden directories (from SAPience experience)
            FORBIDDEN_DIRS=("app/blobs" "app/image-cdn")
            for dir in "${FORBIDDEN_DIRS[@]}"; do
              if [ -d "$dir" ]; then
                echo "âŒ CRITICAL: Forbidden directory: $dir"
                exit 1
              fi
            done
            ;;
            
          "react")
            echo "âš›ï¸ React specific validations:"
            
            if [ -f "src/App.js" ] || [ -f "src/App.jsx" ] || [ -f "src/App.tsx" ]; then
              echo "âœ… React App component found"
            else
              echo "âŒ CRITICAL: React App component missing"
              exit 1
            fi
            ;;
            
          *)
            echo "ğŸ“¦ Generic project validation passed"
            ;;
        esac
        
        echo "âœ… Structure validation PASSED"

    - name: ğŸ“¦ Dependencies Analysis
      if: needs.detect-project-type.outputs.has_package_json == 'true'
      run: |
        echo "ğŸ“¦ Analyzing dependencies..."
        
        # Install dependencies
        npm ci --prefer-offline --no-audit
        
        # Security audit
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level moderate || echo "âš ï¸ Security issues found - review recommended"
        
        # Check for common problematic packages
        PROBLEMATIC_PACKAGES=("blobshape" "@netlify/blobs")
        
        for package in "${PROBLEMATIC_PACKAGES[@]}"; do
          if npm list "$package" &> /dev/null; then
            echo "âš ï¸ WARNING: Potentially problematic package: $package"
          fi
        done
        
        echo "âœ… Dependencies analysis completed"

    - name: ğŸ§¹ Code Quality Checks
      if: needs.detect-project-type.outputs.has_package_json == 'true'
      run: |
        echo "ğŸ§¹ Running code quality checks..."
        
        # ESLint if available
        if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ] || grep -q "eslint" package.json; then
          echo "ğŸ” Running ESLint..."
          npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || echo "âš ï¸ ESLint warnings found"
        fi
        
        # Prettier if available
        if [ -f ".prettierrc" ] || grep -q "prettier" package.json; then
          echo "ğŸ’… Checking code formatting..."
          npx prettier --check "**/*.{js,jsx,ts,tsx,css,md,json}" || echo "âš ï¸ Formatting issues found"
        fi
        
        # TypeScript if available
        if [ -f "tsconfig.json" ]; then
          echo "ğŸ“ Running TypeScript check..."
          npx tsc --noEmit
        fi
        
        echo "âœ… Code quality checks completed"

    - name: ğŸ—ï¸ Build Validation
      if: needs.detect-project-type.outputs.has_package_json == 'true'
      run: |
        echo "ğŸ—ï¸ Testing build process..."
        
        # Try to build the project
        if grep -q '"build"' package.json; then
          echo "ğŸš€ Running build..."
          npm run build
          
          # Check build output based on project type
          PROJECT_TYPE="${{ needs.detect-project-type.outputs.project_type }}"
          
          case $PROJECT_TYPE in
            "nextjs"|"nextjs-app")
              if [ -d "out" ] || [ -d ".next" ]; then
                echo "âœ… Next.js build successful"
              else
                echo "âŒ CRITICAL: Next.js build failed"
                exit 1
              fi
              ;;
              
            "react")
              if [ -d "build" ] || [ -d "dist" ]; then
                echo "âœ… React build successful"
              else
                echo "âŒ CRITICAL: React build failed"
                exit 1
              fi
              ;;
              
            *)
              echo "âœ… Generic build completed"
              ;;
          esac
        else
          echo "â„¹ï¸ No build script found, skipping build test"
        fi

    - name: ğŸ”’ Security Scan
      run: |
        echo "ğŸ”’ Running security scan..."
        
        # Check for sensitive files
        SENSITIVE_PATTERNS=(".env" "*.key" "*.pem" "*password*" "*secret*")
        
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          if find . -name "$pattern" -not -path "./node_modules/*" -not -name ".env.example" | grep -q .; then
            echo "âš ï¸ WARNING: Potential sensitive files found matching: $pattern"
          fi
        done
        
        # Check for hardcoded secrets
        echo "ğŸ” Scanning for hardcoded secrets..."
        if find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" -not -path "./node_modules/*" | xargs grep -i "password\|secret\|token\|key" | head -3; then
          echo "âš ï¸ WARNING: Potential hardcoded secrets found"
        fi
        
        echo "âœ… Security scan completed"

    - name: ğŸ“Š Generate Quality Report
      run: |
        echo "ğŸ“Š Generating quality report..."
        
        echo "=== UNIVERSAL QUALITY GATE REPORT ==="
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Project Type: ${{ needs.detect-project-type.outputs.project_type }}"
        echo "Date: $(date)"
        echo ""
        
        echo "âœ… QUALITY CHECKS PASSED:"
        echo "  ğŸ“ Structure Validation"
        echo "  ğŸ“¦ Dependencies Check"
        echo "  ğŸ§¹ Code Quality"
        echo "  ğŸ—ï¸ Build Process"
        echo "  ğŸ”’ Security Scan"
        echo ""
        
        echo "ğŸ¯ STATUS: READY FOR DEPLOYMENT âœ…"
        echo "ğŸš€ All quality gates passed successfully!"

    - name: âœ… Quality Gate Success
      run: |
        echo "ğŸ‰ =========================================="
        echo "ğŸ‰ UNIVERSAL QUALITY GATE PASSED!"
        echo "ğŸ‰ =========================================="
        echo "ğŸ›¡ï¸ Zero Error Deployment: AUTHORIZED"
        echo "ğŸš€ Safe to proceed with deployment"

    - name: ğŸš¨ Quality Gate Failure
      if: failure()
      run: |
        echo "ğŸš¨ =========================================="
        echo "ğŸš¨ QUALITY GATE FAILED!"
        echo "ğŸš¨ =========================================="
        echo "âŒ Deployment blocked for safety"
        echo "ğŸ”§ Please fix the issues above"
        echo "ğŸ“§ Review the workflow logs for details"
        exit 1
